# Как клиенты двигаются по воронке продаж

## Обзор

Система воронки продаж позволяет отслеживать движение клиентов от первого контакта до завершения работы. Перемещение клиентов может происходить **автоматически** при определенных событиях или **вручную** через интерфейс CRM.

## Автоматическое перемещение

### 1. Регистрация нового клиента (`/start` в боте)
- **Событие**: Клиент впервые запускает бота
- **Действие**: Автоматически создается запись в CRM и клиент перемещается в этап **"Первичный контакт"**
- **Код**: `services/crm_integration.py::create_client_in_crm()`

### 2. Прохождение опросника
- **Событие**: Клиент завершает опросник и получает бесплатную программу
- **Действие**: Клиент автоматически перемещается в этап **"Консультация"**
- **Код**: `handlers/questionnaire.py` → `CRMIntegration.move_client_to_qualified_stage()`

### 3. Получение оплаты
- **Событие**: Администратор подтверждает оплату (`/confirm_payment`)
- **Действие**: Клиент автоматически перемещается в этап **"Куплена услуга"**
- **Код**: `handlers/admin_payment.py` → `CRMIntegration.move_client_to_paid_stage()`

### 4. Выдача программы
- **Событие**: Клиенту выдается оплаченная программа тренировок
- **Действие**: Клиент автоматически перемещается в этап **"Активный клиент"**
- **Код**: `services/crm_integration.py::save_paid_program()`

## Ручное перемещение

### Через страницу воронки (`/pipeline`)
1. Откройте страницу "Воронка продаж"
2. Найдите клиента в нужной колонке
3. Нажмите на кнопку с названием целевого этапа (например, "→ Консультация")
4. Или кликните на карточку клиента и выберите этап из модального окна

### Через страницу деталей клиента (`/clients/:id`)
1. Откройте страницу клиента
2. В боковой панели найдите секцию "Воронка продаж"
3. Выберите нужный этап из выпадающего списка
4. Изменение сохраняется автоматически

## Этапы воронки (по умолчанию)

1. **Первичный контакт** - Новый лид из бота/сайта
2. **Консультация** - Запланирована/проведена консультация
3. **Принимают решение** - Клиент рассматривает предложение
4. **Куплена услуга** - Оплата получена, программа выдана
5. **Активный клиент** - Клиент выполняет программу
6. **Завершен** - Программа завершена
7. **Неактивен** - Клиент не отвечает/потерян

## История перемещений

Все перемещения клиентов записываются в историю (`client_pipelines` таблица):
- Дата и время перемещения
- Кто переместил (пользователь CRM или система)
- Примечания (автоматические или ручные)
- Исходный и целевой этапы

Историю можно просмотреть:
- На странице деталей клиента (боковая панель)
- В API: `GET /api/clients/{id}/pipeline-history`

## Настройка этапов

Вы можете настраивать этапы воронки:
1. Перейдите в "Воронка продаж" → "⚙️ Настройки"
2. Создавайте, редактируйте или удаляйте этапы
3. Настраивайте порядок, цвета и описания

**Важно**: Нельзя удалить этап, если на нем есть клиенты. Сначала переместите всех клиентов на другие этапы.

## API для перемещения

### Переместить клиента
```http
POST /api/pipeline/clients/{client_id}/move-stage
Content-Type: application/json

{
  "stage_id": 2,
  "notes": "Клиент прошел консультацию"
}
```

### Получить историю перемещений
```http
GET /api/clients/{client_id}/pipeline-history
```

## Программный интерфейс

Для автоматического перемещения в коде используйте:

```python
from services.crm_integration import CRMIntegration

# Переместить по имени этапа
CRMIntegration.move_client_to_stage_by_name(
    client_id=123,
    stage_name="Консультация",
    notes="Клиент прошел опросник"
)

# Или использовать готовые методы:
CRMIntegration.move_client_to_qualified_stage(client_id=123)
CRMIntegration.move_client_to_paid_stage(client_id=123, payment_id=456)
```

## Логирование

Все перемещения логируются:
- В базу данных (таблица `client_pipelines`)
- В логи приложения (через `loguru`)
- В историю на странице клиента

Это позволяет отслеживать весь путь клиента по воронке продаж.

