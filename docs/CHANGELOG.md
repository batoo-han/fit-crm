# История изменений

## [Недавние обновления]

### Улучшения управления файлами и настройками
- ✅ Автоматическая очистка uploads при запуске: удаление неиспользуемых файлов и битых ссылок из БД
- ✅ Понятные имена файлов:
  - Логотипы: `logo_widget.<расширение>`, `logo_site.<расширение>`
  - PDF-файлы: `<id_клиента>_<недель>_weeks_<дата>_<номер>.pdf` (например, `123_4_weeks_13112025_0001.pdf`)
- ✅ Настройки платёжных систем с кнопкой сохранения (все изменения применяются только после нажатия кнопки)
- ✅ Промокод по умолчанию выбирается из списка активных промокодов (предотвращает хаос с несуществующими кодами)
- ✅ Шаблоны программ для PDF-футтеров с плейсхолдерами (CRUD в админке)
- ✅ Очистка программ: архивация отправленных, удаление неиспользуемых

### Улучшения чат-виджета
- ✅ Автоматическое суммирование разговоров для экономии токенов
- ✅ Настройка лимита истории сообщений (1-50 сообщений)
- ✅ Сохранение контекста разговора в localStorage

## [Недавние обновления]

### Добавлен вопрос о локации в опросник
- ✅ Вопрос "Где планируешь тренироваться?" (дом/зал)
- ✅ Учитывается при выборе программы из Google Sheets
- ✅ Сохраняется в базе данных

### Система сохранения программ
- ✅ Программы сохраняются в БД после генерации
- ✅ Команда `/my_programs` для просмотра программ
- ✅ Возможность скачать последнюю программу

### Улучшения генерации программ
- ✅ Улучшена обработка ошибок
- ✅ Fallback на ссылку Google Sheets при ошибках
- ✅ Сохранение программы в БД перед генерацией PDF

## [Система генерации программ]

### Реализовано:
- ✅ Чтение данных из Google Sheets
- ✅ Выбор программы по параметрам клиента
- ✅ Форматирование через LLM (Yandex GPT)
- ✅ Генерация PDF файла
- ✅ Отправка PDF клиенту в Telegram

### Сервисы:
- ✅ `training_program_generator.py` - чтение из Google Sheets
- ✅ `program_formatter.py` - форматирование через LLM
- ✅ `pdf_generator.py` - генерация PDF
- ✅ `program_storage.py` - сохранение в БД

## [Интеграция ЮКасса]

### Реализовано:
- ✅ Создание платежей через ЮКасса
- ✅ Генерация ссылок на оплату
- ✅ Обработка чеков согласно 54-ФЗ
- ✅ Fallback на ручную оплату

## [AI Сервис]

### Реализовано:
- ✅ Поддержка Yandex GPT (yandexgpt-lite)
- ✅ Поддержка OpenAI через ProxyAPI
- ✅ Автоматический fallback между провайдерами
- ✅ Настраиваемые модели и параметры

## [Telegram Бот MVP]

### Реализовано:
- ✅ Главное меню
- ✅ Квалификационный опросник (5 вопросов)
- ✅ Система платежей
- ✅ FAQ
- ✅ Контакты тренера
- ✅ Админ-панель
- ✅ Команды: /start, /program, /my_programs, /price, /contacts, /faq, /stats

## [База данных]

### Модели:
- ✅ Client - информация о клиентах
- ✅ Lead - лиды и квалификация
- ✅ Payment - платежи
- ✅ TrainingProgram - программы тренировок

## [Следующие шаги]

### Планируется:
- [ ] Интеграция с amoCRM
- [ ] Webhook для ЮКасса
- [ ] AI-агент для ответов на вопросы
- [ ] Система замен упражнений
- [ ] Автоматизация соцсетей
- [ ] Реферальная программа
- [ ] Генерация видео-контента
