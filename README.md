# Автоматизированная система продаж фитнес-тренировок (CRM + LLM)

Комплексная платформа для фитнес-бизнеса тренера Данилы Цыганкова (D&K FitBody). Система объединяет CRM, Telegram-бота, веб-сайт с LLM-ассистентом и административную панель для управления программами, клиентами и маркетингом.

## Ключевые возможности

- **CRM и аналитика**: база клиентов, воронка продаж, платежи, тренинговые программы, журнал прогресса.
- **Генератор программ тренировок**: платные программы и демо-версии (первую неделю).
- **Сайт с контактной формой и LLM-чатом**: обращения сохраняются в CRM, уведомления в Telegram, чат-бот на Yandex GPT/OpenAI.
- **Онлайн-оплата на сайте**: клиент выбирает тариф, оплачивает через YooKassa/Tinkoff, получает программу автоматически, статус воронки обновляется.
- **Админ-панель (React)**: настройка сайта, виджета чата, контента, визуальных тем, управление клиентами и программами.
- **Telegram-бот**: выдача программ, FAQ, коммуникация с клиентами.
- **Интеграции**: уведомления в Telegram, гибкое подключение LLM-провайдеров, настройка CORS для локального и продакшн окружений.

## Компоненты проекта

| Компонент | Назначение | Технологии |
|----------|------------|------------|
| `crm_api/` | REST API, бизнес-логика CRM, веб-сервис | FastAPI, SQLAlchemy, Loguru |
| `database/` | Определения моделей и инициализация БД | SQLAlchemy, SQLite (по умолчанию) |
| `services/` | Доменные сервисы (программы, LLM, уведомления) | Python |
| `crm-frontend/` | Веб-интерфейс администратора | React, TypeScript, React Router, React Query, Tailwind CSS |
| `dnk/` | Статический сайт (локально, вне VCS) с формой, LLM-чатом и онлайн-оплатой | HTML/CSS/JS (локальное тестирование) |
| `bot.py` | Telegram-бот | aiogram |
| `Dockerfile.api`, `crm-frontend/Dockerfile`, `docker-compose.yml` | Контейнеризация | Docker, Nginx |

## Технологический стек

- **Backend**: Python 3.11, FastAPI, SQLAlchemy, Pydantic, Uvicorn, Loguru.
- **Frontend (CRM)**: React 18, TypeScript, React Query, Tailwind CSS, Vite.
- **AI**: Yandex GPT, OpenAI (через ProxyAPI), настраиваемый системный промпт.
- **Инфраструктура**: Docker, docker-compose, Nginx (reverse proxy), SQLite (по умолчанию) / возможность подключения PostgreSQL.
- **Интеграции**: Telegram (Aiogram), веб-формы, контакт-виджет сайта, соцсети (Telegram-канал), amoCRM (опционально).
  - Опционально: amoCRM (OAuth2, контакты/лиды) — можно выбрать amoCRM как основную CRM вместо встроенной.

## Документация

- `SETUP_GUIDE.md` — развёртывание и техническая настройка (локально и на Ubuntu Server, Docker).
- `docs/FEATURES.md` — подробное описание функционала по разделам (для пользователей и админов).
- `docs/USER_GUIDE.md` — руководство пользователя (клиент, сайт, бот).
- `docs/ADMIN_GUIDE.md` — инструкция администратора (CRM, настройки, LLM, воронка, маркетинг).

### Интеграция с amoCRM (опционально)
### Планирование контента для соцсетей
- Таблица `social_posts` (платформа, текст, время, статус).
- Эндпоинты `/api/social-posts` (CRUD) + `/process-scheduled`.
- Поддерживается Telegram-канал (нужны `TELEGRAM_BOT_TOKEN`, `TELEGRAM_CHANNEL_ID`) и VK-паблик (нужны `VK_ACCESS_TOKEN`, `VK_GROUP_ID`). Instagram — в планах.
- В боте запущен фоновой планировщик, который отправляет посты каждые 10 минут, если статус `scheduled` и время наступило.
- Telegram: если указан `media_url`, пост уходит как фото с подписью; иначе — текст.
 - VK: поддерживается публикация с картинкой (загрузка на стену через `photos.getWallUploadServer` → `photos.saveWallPhoto` → `wall.post`), либо только текст.
 - Массовое планирование: в админке можно выбрать несколько постов и назначить общее время публикации.
- Последовательное планирование: выберите посты, стартовую дату/время и шаг в минутах — посты будут запланированы с указанным интервалом.
- Тихие часы: сервер поддерживает сдвиг времени публикации за пределы окна (quiet_start/quiet_end) при последовательном планировании.
 - Шаблоны постов: сохранение/применение шаблонов (платформа, заголовок, текст, медиа), ускоряет создание контента.
- Массовое применение шаблона: выберите посты и шаблон — содержимое обновится пакетно; затем можно запланировать по единому времени или последовательно с шагом. Доступен выбор порядка (ID, заголовок, время).

### Система промокодов
- Таблицы `promo_codes` и `promo_code_usages`, поля для типов скидок, лимитов, сроков.
- REST `/api/promocodes` (CRUD + `/check` для проверки суммы и доступности).
- Интеграция с YooKassa: код/скидка попадают в платежи, учёт использования при успешной оплате.
- UI в разделе `Маркетинг` для управления промокодами и проверки вручную.

### Платёжные провайдеры
- Активный провайдер выбирается в админке (`Интеграции → Платёжные системы`): YooKassa или Tinkoff.
- Хранится в `WebsiteSettings.payment_provider`; одновременно активен только один.
- Бот при создании оплаты использует активного провайдера (для Tinkoff — `Init` и выдача `PaymentURL`, для YooKassa — redirect `confirmation_url`).
- Сайт (`/dnk`) умеет инициировать оплату напрямую (`POST /api/website/purchase`): создаётся клиент (или обновляются данные), фиксируется платеж, генерируется программа (если тариф онлайн), после `webhook` программа отправляется клиенту (email/Telegram), этап воронки обновляется.
- Эндпоинты:
  - `POST /api/integrations/amocrm/connect` — сохранить домен/креды и обменять auth_code на токен.
  - `POST /api/integrations/amocrm/enable` — включить/выключить интеграцию (режим `crm.mode` = `amocrm|internal`).
  - `GET /api/integrations/amocrm/status` — состояние (включено/токены/домен).
  - `POST /api/integrations/amocrm/push-client` — выгрузить клиента в amoCRM (upsert контакта).

ENV-переменные (по желанию):
```
AMOCRM_ENABLED=false
AMOCRM_DOMAIN=example.amocrm.ru
AMOCRM_CLIENT_ID=...
AMOCRM_CLIENT_SECRET=...
AMOCRM_REDIRECT_URI=https://your.domain/your-redirect
```

## Быстрый старт (Docker)

```bash
# Клонируйте проект и перейдите в папку
git clone <repo_url>
cd workflow

# Создайте .env на основе примера
cp .env.example .env
nano .env   # заполните обязательные переменные

# Соберите и запустите сервисы
docker compose up -d --build

# Проверка
docker compose ps
```

- Панель администратора доступна по `http://<host>/` (порт 80).
- API доступен по `http://<host>/api/...` (proxied через фронтенд).
- Для обновления: `git pull && docker compose up -d --build`.

Подробности — в `SETUP_GUIDE.md`.

### Production развертывание (Ubuntu Server)

Для развертывания на production сервере (например, `batoohan.ru`):

1. **Подготовка сервера**: Установите Docker, Nginx, Certbot
2. **Настройка окружения**: Создайте `.env` файл с production настройками
3. **Развертывание сайта**: Скопируйте папку `dnk/` в `/var/www/batoohan.ru/`
4. **Настройка Nginx**: Используйте конфигурацию из `nginx/nginx.production.conf`
5. **Запуск контейнеров**: `docker compose -f docker-compose.production.yml up -d --build`

**Архитектура:**
- Статический сайт (`dnk/`) обслуживается nginx на хосте на корневом пути `/`
- API проксируется на `/api/` → Docker контейнер `api:8000`
- Админ-панель проксируется на `/admin/` → Docker контейнер `frontend:8080`
- Загрузки проксируются на `/uploads/` → Docker контейнер `api:8000`

Подробные инструкции см. в `docs/PRODUCTION_DEPLOYMENT.md` и `SETUP_GUIDE.md`.

### Быстрый старт для разработки (без Docker)

```bash
# 1. Настройте Python-окружение
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt

# 2. Установите зависимости фронтенда
cd crm-frontend && npm install && cd ..

# 3. Запустите всё одной командой
python run_all.py
```

- Админ-панель: http://localhost:5173/
- API: http://localhost:8009/api/
- Telegram-бот запускается внутри общего процесса; завершить все сервисы — `Ctrl+C`.

Если нужно запускать части по отдельности — в разделе «Запуск в режиме разработки» описаны команды для каждого сервиса.

## Запуск в режиме разработки

### Backend (FastAPI)
1. Создайте виртуальное окружение и установите зависимости:
   ```bash
   python -m venv .venv
   source .venv/bin/activate  # Windows: .venv\Scripts\activate
   pip install -r requirements.txt
   ```
2. Настройте `.env` (копия из `.env.example`).
3. Инициализируйте БД (при необходимости) и запустите API:
   ```bash
   python run_crm_api.py
   ```

### Frontend (React)
```bash
cd crm-frontend
npm install
npm run dev  # Vite dev server (порт 5173 по умолчанию)
```

### Telegram-бот
```bash
python bot.py
```

## Структура репозитория (основные директории)

```
workflow/
├── crm_api/               # Бэкенд: роутеры, схемы, middleware
├── crm-frontend/          # Интерфейс администратора (React + Tailwind)
├── database/              # SQLAlchemy модели и инициализация
├── services/              # Бизнес-логика (программы, LLM, уведомления)
├── docs/                  # Руководства для пользователей и администраторов
├── scripts/               # Утилиты и вспомогательные скрипты (при наличии)
├── Dockerfile.api         # Dockerfile для FastAPI сервиса
├── docker-compose.yml     # Оркестрация фронтенда и API
├── SETUP_GUIDE.md         # Пошаговый гайд по установке и деплою
├── README.md              # Этот файл
└── ...
```

> Папка `dnk/` используется только как локальный прототип сайта и исключена из Git. При необходимости обновите код сайта локально и перенесите на сервер вручную.

## Контакты и поддержка

- Тренер: Данила Цыганков (@DandK_FitBody)
- Для технических вопросов — создайте issue в репозитории или свяжитесь по контактам в CRM.

## Лицензия

Проприетарное ПО. Распространение ограничено владельцем проекта.
